{% extends "booker/_booker_base.html" %}

{% block title %}General Preferences{% endblock %}

{% block content %}
<div class="header-bar">
    <h2>General Preferences</h2>
</div>

<form class="wide-form" method="POST" action="{{ url_for('prefs.general_prefs') }}" enctype="multipart/form-data">
    <fieldset class="form-section">
        <legend><h3>League Identity</h3></legend>
        <div class="form-group">
            <label for="league_name">League Name</label>
            <input type="text" id="league_name" name="league_name" value="{{ prefs.league_name }}" required>
        </div>
        <div class="form-group">
            <label for="league_short">League Abbreviation</label>
            <input type="text" id="league_short" name="league_short" value="{{ prefs.league_short }}" required>
        </div>
    </fieldset>

    <fieldset class="form-section">
        <legend><h3>League Branding</h3></legend>
        <div class="form-group">
            <label for="league_logo">League Logo (PNG, JPG, GIF)</label>
            <input type="file" id="league_logo" name="league_logo" accept="image/png, image/jpeg, image/gif">
            {% if league_logo_url %}
                <p>Current Logo:</p>
                <img src="{{ league_logo_url }}" alt="League Logo" style="max-width: 150px; height: auto; margin-top: 10px;">
                <div class="form-check mt-2">
                    <input type="checkbox" class="form-check-input" id="delete_logo" name="delete_logo">
                    <label class="form-check-label" for="delete_logo">Delete current logo</label>
                </div>
            {% endif %}
            <small class="form-text text-muted">Upload a logo for use in Fan Mode headers. Not required.</small>
        </div>
    </fieldset>

    <fieldset class="form-section">
        <legend><h3>Fan Mode Preferences</h3></legend>
        <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="fan_mode_show_logo" name="fan_mode_show_logo" {% if prefs.fan_mode_show_logo %}checked{% endif %}>
            <label class="form-check-label" for="fan_mode_show_logo">Show League Logo in Header</label>
            <small class="form-text text-muted">Display the uploaded league logo in the Fan Mode header.</small>
        </div>
        <div class="form-group">
            <label for="fan_mode_header_name_display">League Name Display</label>
            <select class="form-control" id="fan_mode_header_name_display" name="fan_mode_header_name_display">
                <option value="Full Name" {% if prefs.fan_mode_header_name_display == "Full Name" %}selected{% endif %}>Full Name</option>
                <option value="Abbreviation" {% if prefs.fan_mode_header_name_display == "Abbreviation" %}selected{% endif %}>Abbreviation</option>
            </select>
            <small class="form-text text-muted">Choose how the league name appears in the Fan Mode header.</small>
        </div>

        <hr class="subsection-divider">

        <legend><h4>Roster & Events Presentation</h4></legend>
        <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="fan_mode_show_records" name="fan_mode_show_records" {% if prefs.fan_mode_show_records %}checked{% endif %}>
            <label class="form-check-label" for="fan_mode_show_records">Show Win/Loss Records</label>
            <small class="form-text text-muted">Display wrestler and tag team win/loss records on roster pages.</small>
        </div>
        <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="fan_mode_show_profile_records" name="fan_mode_show_profile_records" {% if prefs.fan_mode_show_profile_records %}checked{% endif %}>
            <label class="form-check-label" for="fan_mode_show_profile_records">Show 'Records' Section on Profile Pages</label>
            <small class="form-text text-muted">Display the win/loss records section on individual wrestler and tag team profile pages.</small>
        </div>
        <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="fan_mode_show_contract_info" name="fan_mode_show_contract_info" {% if prefs.fan_mode_show_contract_info %}checked{% endif %}>
            <label class="form-check-label" for="fan_mode_show_contract_info">Show 'Contract Info' Section on Profile Pages</label>
            <small class="form-text text-muted">Display contract details (e.g., signing date, expiration) on individual wrestler and tag team profile pages.</small>
        </div>
        <div class="form-group">
            <label for="fan_mode_roster_sort_order">Roster Sort Order</label>
            <select class="form-control" id="fan_mode_roster_sort_order" name="fan_mode_roster_sort_order">
                <option value="Alphabetical" {% if prefs.fan_mode_roster_sort_order == "Alphabetical" %}selected{% endif %}>Alphabetical</option>
                <option value="Total Wins" {% if prefs.fan_mode_roster_sort_order == "Total Wins" %}selected{% endif %}>Total Wins</option>
                <option value="Win Percentage" {% if prefs.fan_mode_roster_sort_order == "Win Percentage" %}selected{% endif %}>Win Percentage</option>
            </select>
            <small class="form-text text-muted">How wrestlers and tag teams are sorted on their respective roster pages.</small>
        </div>
        <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="fan_mode_show_future_events" name="fan_mode_show_future_events" {% if prefs.fan_mode_show_future_events %}checked{% endif %}>
            <label class="form-check-label" for="fan_mode_show_future_events">Show Upcoming Events</label>
            <small class="form-text text-muted">Display events with 'Future' status in Fan Mode.</small>
        </div>
        <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="fan_mode_show_non_match_headers" name="fan_mode_show_non_match_headers" {% if prefs.fan_mode_show_non_match_headers %}checked{% endif %}>
            <label class="form-check-label" for="fan_mode_show_non_match_headers">Show Non-Match Segment Headers</label>
            <small class="form-text text-muted">Display headers for segments like Promos, Interviews, etc., on event pages.</small>
        </div>
        <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="fan_mode_show_quick_results" name="fan_mode_show_quick_results" {% if prefs.fan_mode_show_quick_results %}checked{% endif %}>
            <label class="form-check-label" for="fan_mode_show_quick_results">Display Quick Results Section</label>
            <small class="form-text text-muted">Show a quick results summary at the bottom of past event pages.</small>
        </div>

        <hr class="subsection-divider">

        <legend><h4>Roster Status Display</h4></legend>
        <div class="form-group">
            <label for="fan_mode_injured_wrestler_display">Injured Wrestler Display</label>
            <select class="form-control" id="fan_mode_injured_wrestler_display" name="fan_mode_injured_wrestler_display">
                <option value="Show Normally" {% if prefs.fan_mode_injured_wrestler_display == "Show Normally" %}selected{% endif %}>Show Normally</option>
                <option value="Show with Status" {% if prefs.fan_mode_injured_wrestler_display == "Show with Status" %}selected{% endif %}>Show with Status (e.g., John Doe (Injured))</option>
                <option value="Don't Show" {% if prefs.fan_mode_injured_wrestler_display == "Don't Show" %}selected{% endif %}>Don't Show</option>
            </select>
            <small class="form-text text-muted">How wrestlers with 'Injured' status appear on the Fan Mode roster.</small>
        </div>
        <div class="form-group">
            <label for="fan_mode_suspended_roster_display">Suspended Roster Member Display</label>
            <select class="form-control" id="fan_mode_suspended_roster_display" name="fan_mode_suspended_roster_display">
                <option value="Show Normally" {% if prefs.fan_mode_suspended_roster_display == "Show Normally" %}selected{% endif %}>Show Normally</option>
                <option value="Show with Status" {% if prefs.fan_mode_suspended_roster_display == "Show with Status" %}selected{% endif %}>Show with Status (e.g., John Doe (Suspended) / The Team (Suspended))</option>
                <option value="Don't Show" {% if prefs.fan_mode_suspended_roster_display == "Don't Show" %}selected{% endif %}>Don't Show</option>
            </select>
            <small class="form-text text-muted">How wrestlers and tag teams with 'Suspended' status appear on the Fan Mode roster.</small>
        </div>

        <hr class="subsection-divider">

        <legend><h4>Homepage Layout</h4></legend>
        <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="fan_mode_home_show_champions" name="fan_mode_home_show_champions" {% if prefs.fan_mode_home_show_champions %}checked{% endif %}>
            <label class="form-check-label" for="fan_mode_home_show_champions">Show Current Champions on Homepage</label>
            <small class="form-text text-muted">Display a list of current champions on the Fan Mode homepage.</small>
        </div>
        <div class="form-group">
            <label for="fan_mode_home_show_news">News Display Style on Homepage</label>
            <select class="form-control" id="fan_mode_home_show_news" name="fan_mode_home_show_news">
                <option value="Off" {% if prefs.fan_mode_home_show_news == "Off" %}selected{% endif %}>Off</option>
                <option value="Show Links Only" {% if prefs.fan_mode_home_show_news == "Show Links Only" %}selected{% endif %}>Show Links Only</option>
                <option value="Show Full Posts" {% if prefs.fan_mode_home_show_news == "Show Full Posts" %}selected{% endif %}>Show Full Posts</option>
            </select>
            <small class="form-text text-muted">Control how news posts are displayed on the Fan Mode homepage.</small>
        </div>
        <div class="form-group">
            <label for="fan_mode_home_number_news">Number of News Items to Show</label>
            <input type="number" class="form-control" id="fan_mode_home_number_news" name="fan_mode_home_number_news" value="{{ prefs.fan_mode_home_number_news }}" min="1" max="10">
            <small class="form-text text-muted">Maximum number of news items to display on the homepage.</small>
        </div>
        <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="fan_mode_home_show_recent_events" name="fan_mode_home_show_recent_events" {% if prefs.fan_mode_home_show_recent_events %}checked{% endif %}>
            <label class="form-check-label" for="fan_mode_home_show_recent_events">Show Recent Events on Homepage</label>
            <small class="form-text text-muted">Display a list of recently concluded events on the Fan Mode homepage.</small>
        </div>
        <div class="form-group">
            <label for="fan_mode_home_number_events">Number of Recent Events to Show</label>
            <input type="number" class="form-control" id="fan_mode_home_number_events" name="fan_mode_home_number_events" value="{{ prefs.fan_mode_home_number_events }}" min="1" max="10">
            <small class="form-text text-muted">Maximum number of recent events to display on the homepage.</small>
        </div>
    </fieldset>

    <fieldset class="form-section">
        <legend><h3>Units</h3></legend>
        <div class="form-group">
            <label>Weight Unit</label>
            <div class="radio-group">
                <input type="radio" id="weight_unit_lbs" name="weight_unit" value="lbs." {% if prefs.weight_unit == 'lbs.' %}checked{% endif %}>
                <label for="weight_unit_lbs">Pounds (lbs.)</label>
                <input type="radio" id="weight_unit_kg" name="weight_unit" value="kg." {% if prefs.weight_unit == 'kg.' %}checked{% endif %}>
                <label for="weight_unit_kg">Kilograms (kg.)</label>
            </div>
        </div>
    </fieldset>

    <fieldset class="form-section">
        <legend><h3>AI Assistant Configuration</h3></legend>
        <div class="form-group">
            <label for="ai_provider">AI Provider</label>
            <select class="form-control" id="ai_provider" name="ai_provider">
                <option value="">-- Select Provider --</option>
                {% for provider in available_models.keys() %}
                <option value="{{ provider }}" {% if prefs.ai_provider == provider %}selected{% endif %}>{{ provider }}</option>
                {% endfor %}
            </select>
            <small class="form-text text-muted">Choose the AI service to use for assistant features.</small>
        </div>
        <div class="form-group">
            <label for="ai_model">Model</label>
            <select class="form-control" id="ai_model" name="ai_model">
                <!-- Options will be populated by JavaScript -->
            </select>
            <small class="form-text text-muted">Select the specific AI model to use.</small>
        </div>
        <div class="form-group" id="google_api_key_group" style="display: none;">
            <label for="google_api_key">Google API Key</label>
            <input type="password" class="form-control" id="google_api_key" name="google_api_key" value="{{ prefs.google_api_key }}">
            <small class="form-text text-muted">Enter your Google API Key for Gemini models.</small>
        </div>
        <div class="form-group" id="openai_api_key_group" style="display: none;">
            <label for="openai_api_key">OpenAI API Key</label>
            <input type="password" class="form-control" id="openai_api_key" name="openai_api_key" value="{{ prefs.openai_api_key }}">
            <small class="form-text text-muted">Enter your OpenAI API Key for GPT models.</small>
        </div>
    </fieldset>

    <fieldset class="form-section">
        <legend><h3>Game Date Settings</h3></legend>
        <div class="form-group">
            <label>Game Date Mode</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="game_date_mode" id="game_date_mode_realtime" value="real-time" {% if prefs.game_date_mode == "real-time" %}checked{% endif %}>
                <label class="form-check-label" for="game_date_mode_realtime">
                    Use Real Time Date (Application uses today's actual date)
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="game_date_mode" id="game_date_mode_latest_event" value="latest-event-date" {% if prefs.game_date_mode == "latest-event-date" %}checked{% endif %}>
                <label class="form-check-label" for="game_date_mode_latest_event">
                    Use Latest Event/News Date (Application date advances with booked events/news)
                </label>
            </div>
            {% if prefs.game_date_mode == "latest-event-date" %}
                <p class="form-text text-muted mt-2">Current Game Date: <strong>{{ current_game_date }}</strong></p>
            {% endif %}
            <small class="form-text text-muted">Choose how the application determines its current date for calculations (e.g., reign durations).</small>
        </div>
    </fieldset>

    <div class="action-buttons form-actions">
        <button type="submit" class="btn btn-primary">Save Preferences</button>
    </div>
</form>

<script>
    const modelsByProvider = {{ available_models | tojson | safe }};
    const aiProviderSelect = document.getElementById('ai_provider');
    const aiModelSelect = document.getElementById('ai_model');
    const googleApiKeyGroup = document.getElementById('google_api_key_group');
    const openaiApiKeyGroup = document.getElementById('openai_api_key_group');

    function updateAIConfigUI() {
        const selectedProvider = aiProviderSelect.value;
        const currentModel = "{{ prefs.ai_model }}"; // Get the currently saved model from preferences

        // Clear existing models
        aiModelSelect.innerHTML = '';

        // Hide all API key fields
        googleApiKeyGroup.style.display = 'none';
        openaiApiKeyGroup.style.display = 'none';

        if (selectedProvider) {
            const models = modelsByProvider[selectedProvider];
            if (models) {
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    if (model === currentModel) {
                        option.selected = true;
                    }
                    aiModelSelect.appendChild(option);
                });
            }

            // Show the relevant API key field
            if (selectedProvider === "Google") {
                googleApiKeyGroup.style.display = 'block';
            } else if (selectedProvider === "OpenAI") {
                openaiApiKeyGroup.style.display = 'block';
            }
        } else {
            // If no provider is selected, add a default "Select Model" option
            const option = document.createElement('option');
            option.value = "";
            option.textContent = "-- Select Model --";
            aiModelSelect.appendChild(option);
        }
    }

    // Initial UI update on page load
    document.addEventListener('DOMContentLoaded', updateAIConfigUI);

    // Update UI when provider changes
    aiProviderSelect.addEventListener('change', updateAIConfigUI);
</script>

<hr class="section-divider">

<fieldset class="form-section danger-zone">
    <legend><h3>Danger Zone</h3></legend>
    
    <!-- Reset Records Section -->
    <div class="form-group">
        <label>Reset All Records</label>
        <p>This will set the win, loss, and draw records for **every wrestler and tag team** back to zero. This is useful for starting a new season.</p>
        <button id="reset-button" class="btn btn-danger" onclick="document.getElementById('reset-confirmation').style.display='block'; this.style.display='none';">
            Reset All Win/Loss Records
        </button>
    </div>
    <div id="reset-confirmation" style="display: none;">
        <form method="POST" action="{{ url_for('prefs.reset_records') }}">
            <div class="form-group">
                <label for="confirmation-reset">To confirm, please type `RESET` in the box below:</label>
                <input type="text" id="confirmation-reset" name="confirmation" required>
            </div>
            <div class="action-buttons">
                <button type="submit" class="btn btn-danger">I understand, reset all records</button>
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('reset-confirmation').style.display='none'; document.getElementById('reset-button').style.display='block';">
                    Cancel
                </button>
            </div>
        </form>
    </div>

    <hr class="subsection-divider">

    <!-- Recalculate Tag Team Weights Section -->
    <div class="form-group">
        <label>Recalculate All Tag Team Weights</label>
        <p>This will re-calculate the combined weight for all tag teams based on their current members' weights. This is useful if wrestler weights have changed or if you suspect an inconsistency.</p>
        <form method="POST" action="{{ url_for('prefs.recalculate_tagteam_weights_route') }}">
            <button type="submit" class="btn btn-info">Recalculate All Tag Team Weights</button>
        </form>
    </div>

    <hr class="subsection-divider">

    <!-- Clear Temp Files Section -->
    <div class="form-group">
        <label>Clear Temporary Files</label>
        <p>This will delete all generated segment summary files from the `includes/tmp` directory. This is a safe cleanup operation and will not affect your core league data (wrestlers, events, etc.).</p>
        <button id="clear-button" class="btn btn-warning" onclick="document.getElementById('clear-confirmation').style.display='block'; this.style.display='none';">
            Clear All Temporary Files
        </button>
    </div>
    <div id="clear-confirmation" style="display: none;">
        <form method="POST" action="{{ url_for('prefs.clear_temp_files') }}">
            <div class="form-group">
                <label for="confirmation-clear">To confirm, please type `CLEAR` in the box below:</label>
                <input type="text" id="confirmation-clear" name="confirmation" required>
            </div>
            <div class="action-buttons">
                <button type="submit" class="btn btn-danger">I understand, clear temporary files</button>
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('clear-confirmation').style.display='none'; document.getElementById('clear-button').style.display='block';">
                    Cancel
                </button>
            </div>
        </form>
    </div>

</fieldset>
{% endblock %}

